<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KINGXREEK Playlist</title>
<style>
body { font-family:"Poppins",sans-serif; background:#0d001a; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; margin:0; padding:20px; }
.card { width:480px; background:#1a0033; padding:20px; border-radius:20px; box-shadow:0 0 25px rgba(128,0,255,0.4); }
img { width:100%; border-radius:16px; margin-bottom:20px; object-fit:cover; box-shadow:0 0 25px rgba(128,0,255,0.6); }
h1 { text-align:center; margin-bottom:20px; color:#bb86fc; text-shadow:0 0 8px rgba(128,0,255,0.7); }
.subscribe-container { text-align:center; margin-bottom:15px; }
.subscribe-button { background:#ff6bf7; border:none; color:#000; font-weight:700; padding:10px 20px; border-radius:10px; cursor:pointer; box-shadow:0 0 10px #ff6bf7; font-size:16px; transition:all 0.2s ease; }
.subscribe-button:hover { background:#ff8cff; transform:scale(1.05); }
.controls { margin-bottom:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
.buttons { display:flex; justify-content:center; flex-wrap:wrap; gap:8px; }
button { background:#bb86fc; border:none; color:#000; font-weight:600; padding:8px 12px; border-radius:8px; cursor:pointer; transition:all 0.2s ease; box-shadow:0 0 8px rgba(128,0,255,0.6); }
button:hover { background:#d3a1ff; transform:scale(1.05); }
.now-playing { background:#240046; padding:15px; border-radius:15px; margin-bottom:15px; box-shadow:0 0 15px rgba(128,0,255,0.4); width:100%; text-align:center; transition:all 0.3s ease-in-out; }
.now-playing.active { box-shadow:0 0 18px #a64dff; background:#30005a; }
.now-playing h2 { margin:0; font-size:16px; color:#bb86fc; font-weight:700; }
.now-playing p { margin:4px 0 8px; font-size:14px; color:#fff; }
.slider-row { display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%; }
.progress-container { display:flex; align-items:center; flex:1; gap:8px; }
#progress { flex:1; height:6px; border-radius:4px; appearance:none; background:linear-gradient(to right,#8000FF 0%,#333 0%); outline:none; cursor:pointer; transition:background 0.2s; }
#progress::-webkit-slider-thumb { appearance:none; height:12px; width:12px; border-radius:50%; background:#fff; border:2px solid #8000FF; cursor:pointer; margin-top:-3px; }
#volume { width:70px; accent-color:#8000FF; cursor:pointer; }
.time { font-size:12px; color:#aaa; width:40px; text-align:center; }
#playlist { max-height:250px; overflow-y:auto; background:#120024; border-radius:10px; padding:10px; box-shadow:inset 0 0 10px rgba(128,0,255,0.2); }
.track { margin:8px 0; padding:10px; border-radius:8px; background:#1a1a1a; display:flex; justify-content:space-between; align-items:center; transition:all 0.3s ease-in-out; }
.track:hover { background:#2a2a2a; box-shadow:0 0 8px #8000FF40; }
.track.active { background:#2a0033; box-shadow:0 0 16px #8000FFAA; transform:scale(1.02); }

/* ===== Button glow for subscription ===== */
.track button {
  pointer-events: none;
  opacity: 0.4;
  background: #bb86fc;
  color: #000;
  font-weight: 600;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 0 8px rgba(128,0,255,0.6);
}
.track button.unlocked {
  pointer-events: auto;
  opacity: 1;
  box-shadow: 0 0 12px #ff6bf7, 0 0 20px #8000FF70;
  transform: scale(1.05);
}
.track button:hover.unlocked {
  box-shadow: 0 0 16px #ff6bf7, 0 0 25px #8000FFAA;
  transform: scale(1.1);
}

/* ===== Admin Panel ===== */
#adminPanel { display:none; margin-top:20px; }
#adminPanel h2 { color:#ff6bf7; text-align:center; margin-bottom:10px; }
#adminPanel input { padding:8px; border-radius:8px; border:none; outline:none; flex:1; }
#adminPanel button { background:#ff6bf7; color:#000; font-weight:700; padding:8px 16px; border-radius:8px; cursor:pointer; }
#adminPlaysList li { padding:6px; border-bottom:1px solid #333; }
</style>
</head>
<body>
<div class="card">
<img src="Cover.JPG" alt="Cover">
<h1>KINGXREEK Playlist</h1>

<div class="subscribe-container">
  <button class="subscribe-button" id="subscribeBtn">Subscribe $7.99/mo</button>
</div>

<div class="controls">
  <div class="buttons">
    <button onclick="prev()">‚èÆ Prev</button>
    <button onclick="toggle()">‚ñ∂Ô∏è / ‚è∏</button>
    <button onclick="next()">‚è≠ Next</button>
    <button onclick="shuffle()">üîÄ Shuffle</button>
    <button onclick="loop()">üîÅ Repeat</button>
  </div>
  <div class="now-playing" id="nowPlaying">
    <h2>KINGXREEK</h2>
    <p id="songTitle">Loading...</p>
    <div class="slider-row">
      <div class="progress-container">
        <span class="time" id="currentTime">0:00</span>
        <input type="range" id="progress" min="0" max="100" value="0">
        <span class="time" id="duration">0:00</span>
      </div>
      <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
    </div>
  </div>
</div>

<div id="playlist"></div>

<!-- ===== Hidden Admin Panel ===== -->
<div id="adminPanel">
  <h2>Admin - Song Plays</h2>
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <input type="password" id="adminSecretInput" placeholder="Enter admin secret">
    <button onclick="unlockAdmin()">Unlock</button>
  </div>
  <ul id="adminPlaysList"></ul>
</div>

<audio id="player"></audio>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const BACKEND_URL = "https://stripe-backend-o6oh.onrender.com";
const subscribeBtn = document.getElementById('subscribeBtn');
const playlistDiv = document.getElementById('playlist');
const player = document.getElementById('player');
let isSubscribed = false;

// Songs array
const songs = [
  {title:"Been Waiting", file:"Been_Waiting.mp3"},
  {title:"The Marina", file:"The_Marina.mp3"},
  {title:"What It Wasn't", file:"What_It_Wasnt.mp3"},
  {title:"Put Me In Coach", file:"Put_Me_In_Coach.mp3"},
  {title:"Attachments", file:"Attachments.mp3"},
  {title:"Gangsta", file:"Gangsta.mp3"},
  {title:"Abuntu", file:"Abuntu.mp3"},
  {title:"Places They Can't Go", file:"Places_They_Cant_Go.mp3"},
  {title:"Mdali", file:"Mdali.mp3"},
  {title:"Bawo", file:"Bawo.mp3"},
  {title:"Black Magic", file:"Black_Magic.mp3"},
  {title:"Thinking Out Loud", file:"Thinking_Out_Loud.mp3"}
];

const trackElements = [];
function renderPlaylist() {
  playlistDiv.innerHTML = "";
  songs.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="track";
    div.innerHTML=`<span>${s.title}</span><button onclick="play(${i})">Play</button>`;
    playlistDiv.appendChild(div);
    trackElements.push(div);
  });
}
renderPlaylist();

function lockPlayer() {
  trackElements.forEach(t=>{
    const b = t.querySelector("button");
    b.disabled = true;
    b.style.pointerEvents = "none";
    b.style.opacity = "0.4";
    b.classList.remove("unlocked");
  });
  player.pause();
}

function unlockPlayer() {
  trackElements.forEach(t=>{
    const b = t.querySelector("button");
    b.disabled = false;
    b.style.pointerEvents = "auto";
    b.style.opacity = "1";
    b.classList.add("unlocked");
  });
}

lockPlayer();

// ===== Music Player functions =====
let current=0;
function load(i){ 
  player.src=songs[i].file; 
  player.play(); 
  highlightTrack(i); 
  updateNowPlaying(i); 
  current=i; 
  if(isSubscribed) recordPlay(i);
}

function play(i){ if(!isSubscribed) return; load(i); }
function next(){ if(!isSubscribed) return; current=(current+1)%songs.length; load(current); }
function prev(){ if(!isSubscribed) return; current=(current-1+songs.length)%songs.length; load(current); }
function shuffle(){ if(!isSubscribed) return; current=Math.floor(Math.random()*songs.length); load(current); }
function loop(){ if(!isSubscribed) return; player.loop=!player.loop; alert("Repeat "+(player.loop?"ON":"OFF")); }
function toggle(){ if(!isSubscribed) return; player.paused?player.play():player.pause(); }
function highlightTrack(i){ trackElements.forEach((t,idx)=>{ t.classList.toggle('active',idx===i); }); }
function updateNowPlaying(i){ document.getElementById('songTitle').textContent=songs[i].title; document.getElementById('nowPlaying').classList.add("active"); }
function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60).toString().padStart(2,"0"); return `${m}:${s}`; }

player.addEventListener('ended',next);
player.addEventListener('timeupdate',()=>{
  if(player.duration){
    const percent=(player.currentTime/player.duration)*100;
    document.getElementById('progress').value=percent;
    document.getElementById('progress').style.background=`linear-gradient(to right,#8000FF ${percent}%,#333 ${percent}%)`;
    document.getElementById('currentTime').textContent=formatTime(player.currentTime);
    document.getElementById('duration').textContent=formatTime(player.duration);
  }
});
document.getElementById('progress').addEventListener('input',()=>{ if(player.duration) player.currentTime=(document.getElementById('progress').value/100)*player.duration; });
document.getElementById('volume').addEventListener('input',()=>{ player.volume=document.getElementById('volume').value; });

// ===== Stripe Subscription =====
subscribeBtn.addEventListener("click", async ()=>{
  try{
    const res=await fetch(BACKEND_URL+"/create-checkout-session",{method:"POST"});
    const data=await res.json();
    if(data.url) window.location.href=data.url;
    else alert("Error creating checkout session");
  }catch(e){ console.error(e); alert("Something went wrong. Make sure backend is live and env variables are correct."); }
});

// ===== Check subscription (simple demo) =====
async function checkSubscription() {
  try{
    const res=await fetch(BACKEND_URL+"/check-subscription");
    const data = await res.json();
    if(data.active){ isSubscribed=true; unlockPlayer(); subscribeBtn.style.display="none"; }
  }catch(e){ console.error(e); }
}
checkSubscription();

// ===== Auto-unlock after Stripe payment =====
function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

async function autoUnlockAfterPayment() {
    const sessionId = getQueryParam('session_id');
    if (!sessionId) return;
    try {
        const res = await fetch(`${BACKEND_URL}/check-subscription?session_id=${sessionId}`);
        const data = await res.json();
        if (data.active) {
            isSubscribed = true;
            unlockPlayer();
            subscribeBtn.style.display = "none";
            load(0); // Auto-play first song
        }
    } catch (e) {
        console.error(e);
    }
}

// ===== Track song plays =====
async function recordPlay(i) {
    const song = songs[i].title;
    try {
        await fetch(`${BACKEND_URL}/track-play`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ song }),
        });
    } catch (err) {
        console.error("Error recording play:", err);
    }
}

// ===== Admin Panel =====
async function unlockAdmin() {
    const secret = document.getElementById('adminSecretInput').value.trim();
    if (!secret) return alert("Enter admin secret");

    try {
        const res = await fetch(`${BACKEND_URL}/admin/plays?secret=${encodeURIComponent(secret)}`);
        if (res.status === 403) return alert("‚ùå Wrong secret");

        const data = await res.json();
        const list = document.getElementById('adminPlaysList');
        list.innerHTML = "";
        for (const song in data) {
            const li = document.createElement('li');
            li.textContent = `${song}: ${data[song]} plays`;
            list.appendChild(li);
        }
        document.getElementById('adminPanel').style.display = "block";
    } catch (err) {
        console.error(err);
        alert("‚ùå Error fetching play counts");
    }
}

autoUnlockAfterPayment();
</script>
</body>
</html>
