<script src="https://js.stripe.com/v3/"></script>
<script>
const BACKEND_URL = "https://stripe-backend-o6oh.onrender.com";
const subscribeBtn = document.getElementById('subscribeBtn');
const playlistDiv = document.getElementById('playlist');
const player = document.getElementById('player');
let isSubscribed = false;

// Songs array
const songs = [
  {title:"Been Waiting", file:"Been_Waiting.mp3"},
  {title:"The Marina", file:"The_Marina.mp3"},
  {title:"What It Wasn't", file:"What_It_Wasnt.mp3"},
  {title:"Put Me In Coach", file:"Put_Me_In_Coach.mp3"},
  {title:"Attachments", file:"Attachments.mp3"},
  {title:"Gangsta", file:"Gangsta.mp3"},
  {title:"Abuntu", file:"Abuntu.mp3"},
  {title:"Places They Can't Go", file:"Places_They_Cant_Go.mp3"},
  {title:"Mdali", file:"Mdali.mp3"},
  {title:"Bawo", file:"Bawo.mp3"},
  {title:"Black Magic", file:"Black_Magic.mp3"},
  {title:"Thinking Out Loud", file:"Thinking_Out_Loud.mp3"}
];

const trackElements = [];

// Render playlist
function renderPlaylist() {
  playlistDiv.innerHTML = "";
  songs.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className = "track";
    div.innerHTML = `<span>${s.title}</span><button onclick="play(${i})">Play</button>`;
    playlistDiv.appendChild(div);
    trackElements.push(div);
  });
  console.log("‚úÖ Playlist rendered");
}
renderPlaylist();

// Lock/unlock player buttons
function lockPlayer() {
  trackElements.forEach(t=>{
    const b=t.querySelector("button");
    b.disabled=true; b.style.pointerEvents="none"; b.style.opacity="0.4";
  });
  player.pause();
  console.log("üîí Player locked (not subscribed)");
}
function unlockPlayer() {
  trackElements.forEach(t=>{
    const b=t.querySelector("button");
    b.disabled=false; b.style.pointerEvents="auto"; b.style.opacity="1";
  });
  console.log("üîì Player unlocked (subscribed)");
}
lockPlayer();

// Track a song play
async function recordPlay(i) {
  const song = songs[i].title;
  try {
    const res = await fetch(`${BACKEND_URL}/track-play`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ song }),
    });
    const data = await res.json();
    console.log(`üéµ Played "${song}" - total plays: ${data.plays}`);
  } catch (err) {
    console.warn("‚ö†Ô∏è Error recording play:", err);
  }
}

// Music player functions
let current = 0;
function load(i){ 
  player.src = songs[i].file; 
  player.play(); 
  highlightTrack(i); 
  updateNowPlaying(i); 
  current = i;

  if(isSubscribed) recordPlay(i);
}
function play(i){ if(!isSubscribed) return; load(i); }
function next(){ if(!isSubscribed) return; current=(current+1)%songs.length; load(current); }
function prev(){ if(!isSubscribed) return; current=(current-1+songs.length)%songs.length; load(current); }
function shuffle(){ if(!isSubscribed) return; current=Math.floor(Math.random()*songs.length); load(current); }
function loop(){ if(!isSubscribed) return; player.loop=!player.loop; alert("Repeat "+(player.loop?"ON":"OFF")); }
function toggle(){ if(!isSubscribed) return; player.paused?player.play():player.pause(); }
function highlightTrack(i){ trackElements.forEach((t,idx)=>{ t.classList.toggle('active',idx===i); }); }
function updateNowPlaying(i){ 
  document.getElementById('songTitle').textContent=songs[i].title; 
  document.getElementById('nowPlaying').classList.add("active"); 
}
function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60).toString().padStart(2,"0"); return `${m}:${s}`; }

player.addEventListener('ended', next);
player.addEventListener('timeupdate', ()=>{
  if(player.duration){
    const percent=(player.currentTime/player.duration)*100;
    document.getElementById('progress').value=percent;
    document.getElementById('progress').style.background=`linear-gradient(to right,#8000FF ${percent}%,#333 ${percent}%)`;
    document.getElementById('currentTime').textContent=formatTime(player.currentTime);
    document.getElementById('duration').textContent=formatTime(player.duration);
  }
});
document.getElementById('progress').addEventListener('input', ()=>{
  if(player.duration) player.currentTime=(document.getElementById('progress').value/100)*player.duration;
});
document.getElementById('volume').addEventListener('input', ()=>{
  player.volume=document.getElementById('volume').value;
});

// Stripe subscription
subscribeBtn.addEventListener("click", async ()=>{
  try{
    const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {method:"POST"});
    const data = await res.json();
    if(data.url) window.location.href = data.url;
    else alert("‚ùå Error creating checkout session");
  }catch(e){
    console.error("‚ö†Ô∏è Stripe checkout error:", e);
    alert("Something went wrong. Make sure backend is live and env variables are correct.");
  }
});

// Check subscription status
async function checkSubscription() {
  try{
    const res = await fetch(`${BACKEND_URL}/check-subscription`);
    const data = await res.json();
    if(data.active){
      isSubscribed = true;
      unlockPlayer();
      subscribeBtn.style.display = "none";
    }
  }catch(e){ console.warn("‚ö†Ô∏è Subscription check failed", e); }
}
checkSubscription();

// Auto-unlock after Stripe payment
function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}
async function autoUnlockAfterPayment() {
  const sessionId = getQueryParam('session_id');
  if(!sessionId) return;

  try {
    const res = await fetch(`${BACKEND_URL}/check-subscription?session_id=${sessionId}`);
    const data = await res.json();
    if(data.active){
      isSubscribed = true;
      unlockPlayer();
      subscribeBtn.style.display = "none";
      load(0); // Auto-play first song
      console.log("‚úÖ Subscription active, player unlocked");
    }
  } catch(e){ console.warn("‚ö†Ô∏è Auto-unlock failed", e); }
}
autoUnlockAfterPayment();
</script>
