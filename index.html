<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KINGXREEK Playlist</title>
<style>
  body { font-family: "Poppins", sans-serif; background: #111; color: #fff; margin: 0; padding: 20px; }
  #playlist { margin-top: 20px; }
  .track { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
  .track.active span { font-weight: bold; color: #8000FF; }
  button { padding: 5px 10px; border: none; border-radius: 5px; background: #8000FF; color: #fff; cursor: pointer; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  #player-controls { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
  #nowPlaying { margin-top: 10px; font-weight: bold; }
  #progress, #volume { width: 100%; }
</style>
</head>
<body>

<h1>KINGXREEK Playlist</h1>
<button id="subscribeBtn">Subscribe to Unlock All Songs</button>

<div id="nowPlaying">
  <span id="songTitle"></span>
</div>

<audio id="player" controls></audio>

<div id="player-controls">
  <button onclick="prev()">Prev</button>
  <button onclick="play(current)">Play</button>
  <button onclick="next()">Next</button>
  <button onclick="shuffle()">Shuffle</button>
  <button onclick="loop()">Loop</button>
</div>

<input type="range" id="progress" min="0" max="100" value="0">
<input type="range" id="volume" min="0" max="1" step="0.01" value="1">
<div>
  <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
</div>

<div id="playlist"></div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const BACKEND_URL = "https://stripe-backend-o6oh.onrender.com";
const subscribeBtn = document.getElementById('subscribeBtn');
const playlistDiv = document.getElementById('playlist');
const player = document.getElementById('player');
let isSubscribed = false;

const songs = [
  {title:"Been Waiting", file:"Been_Waiting.mp3"},
  {title:"The Marina", file:"The_Marina.mp3"},
  {title:"What It Wasn't", file:"What_It_Wasnt.mp3"},
  {title:"Put Me In Coach", file:"Put_Me_In_Coach.mp3"},
  {title:"Attachments", file:"Attachments.mp3"},
  {title:"Gangsta", file:"Gangsta.mp3"},
  {title:"Abuntu", file:"Abuntu.mp3"},
  {title:"Places They Can't Go", file:"Places_They_Cant_Go.mp3"},
  {title:"Mdali", file:"Mdali.mp3"},
  {title:"Bawo", file:"Bawo.mp3"},
  {title:"Black Magic", file:"Black_Magic.mp3"},
  {title:"Thinking Out Loud", file:"Thinking_Out_Loud.mp3"}
];

const trackElements = [];

function renderPlaylist() {
  playlistDiv.innerHTML = "";
  songs.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className = "track";
    div.innerHTML = `<span>${s.title}</span><button onclick="play(${i})">Play</button>`;
    playlistDiv.appendChild(div);
    trackElements.push(div);
  });
  console.log("‚úÖ Playlist rendered");
}
renderPlaylist();

function lockPlayer() {
  trackElements.forEach(t=>{
    const b=t.querySelector("button");
    b.disabled=true; b.style.pointerEvents="none"; b.style.opacity="0.4";
  });
  player.pause();
  console.log("üîí Player locked (not subscribed)");
}
function unlockPlayer() {
  trackElements.forEach(t=>{
    const b=t.querySelector("button");
    b.disabled=false; b.style.pointerEvents="auto"; b.style.opacity="1";
  });
  console.log("üîì Player unlocked (subscribed)");
}
lockPlayer();

async function recordPlay(i) {
  const song = songs[i].title;
  try {
    const res = await fetch(`${BACKEND_URL}/track-play`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ song }),
    });
    const data = await res.json();
    console.log(`üéµ Played "${song}" - total plays: ${data.plays}`);
  } catch (err) {
    console.warn("‚ö†Ô∏è Error recording play:", err);
  }
}

let current = 0;
function load(i){ 
  player.src = songs[i].file; 
  player.play(); 
  highlightTrack(i); 
  updateNowPlaying(i); 
  current = i;

  if(isSubscribed) recordPlay(i);
}
function play(i){ if(!isSubscribed) return; load(i); }
function next(){ if(!isSubscribed) return; current=(current+1)%songs.length; load(current); }
function prev(){ if(!isSubscribed) return; current=(current-1+songs.length)%songs.length; load(current); }
function shuffle(){ if(!isSubscribed) return; current=Math.floor(Math.random()*songs.length); load(current); }
function loop(){ if(!isSubscribed) return; player.loop=!player.loop; alert("Repeat "+(player.loop?"ON":"OFF")); }
function toggle(){ if(!isSubscribed) return; player.paused?player.play():player.pause(); }
function highlightTrack(i){ trackElements.forEach((t,idx)=>{ t.classList.toggle('active',idx===i); }); }
function updateNowPlaying(i){ 
  document.getElementById('songTitle').textContent=songs[i].title; 
  document.getElementById('nowPlaying').classList.add("active"); 
}
function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60).toString().padStart(2,"0"); return `${m}:${s}`; }

player.addEventListener('ended', next);
player.addEventListener('timeupdate', ()=>{
  if(player.duration){
    const percent=(player.currentTime/player.duration)*100;
    document.getElementById('progress').value=percent;
    document.getElementById('progress').style.background=`linear-gradient(to right,#8000FF ${percent}%,#333 ${percent}%)`;
    document.getElementById('currentTime').textContent=formatTime(player.currentTime);
    document.getElementById('duration').textContent=formatTime(player.duration);
  }
});
document.getElementById('progress').addEventListener('input', ()=>{
  if(player.duration) player.currentTime=(document.getElementById('progress').value/100)*player.duration;
});
document.getElementById('volume').addEventListener('input', ()=>{
  player.volume=document.getElementById('volume').value;
});

// Stripe subscription
subscribeBtn.addEventListener("click", async ()=>{
  try{
    const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {method:"POST"});
    const data = await res.json();
    if(data.url) window.location.href = data.url;
    else alert("‚ùå Error creating checkout session");
  }catch(e){
    console.error("‚ö†Ô∏è Stripe checkout error:", e);
    alert("Something went wrong. Make sure backend is live and env variables are correct.");
  }
});

async function checkSubscription() {
  try{
    const res = await fetch(`${BACKEND_URL}/check-subscription`);
    const data = await res.json();
    if(data.active){
      isSubscribed = true;
      unlockPlayer();
      subscribeBtn.style.display = "none";
    }
  }catch(e){ console.warn("‚ö†Ô∏è Subscription check failed", e); }
}
checkSubscription();

function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}
async function autoUnlockAfterPayment() {
  const sessionId = getQueryParam('session_id');
  if(!sessionId) return;

  try {
    const res = await fetch(`${BACKEND_URL}/check-subscription?session_id=${sessionId}`);
    const data = await res.json();
    if(data.active){
      isSubscribed = true;
      unlockPlayer();
      subscribeBtn.style.display = "none";
      load(0);
      console.log("‚úÖ Subscription active, player unlocked");
    }
  } catch(e){ console.warn("‚ö†Ô∏è Auto-unlock failed", e); }
}
autoUnlockAfterPayment();
</script>

</body>
</html>
